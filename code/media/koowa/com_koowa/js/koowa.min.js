/**
 * Nooku Framework - http://nooku.org/framework
 *
 * @copyright	Copyright (C) 2007 - 2014 Johan Janssens and Timble CVBA. (http://www.timble.net)
 * @license		GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
 * @link		https://github.com/nooku/nooku-framework for the canonical source repository
 */if(!Koowa)var Koowa={};Function.prototype.bind||(Function.prototype.bind=function(e){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){return n.apply(this instanceof r&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,i.prototype=new r,i}),function(e){var t=function(){function s(e){return f.call(o(e)?e:function(){},e,1)}function o(e){return typeof e===n}function u(e,t,n){return function(){var r=this.supr;this.supr=n[i][e];var s={}.fabricatedUndefined,o=s;try{o=t.apply(this,arguments)}finally{this.supr=r}return o}}function a(e,t,n){for(var s in t)t.hasOwnProperty(s)&&(e[s]=o(t[s])&&o(n[i][s])&&r.test(t[s])?u(s,t[s],n):t[s])}function f(e,t){function n(){}function c(){this.initialize?this.initialize.apply(this,arguments):(t||u&&r.apply(this,arguments),f.apply(this,arguments))}n[i]=this[i];var r=this,s=new n,u=o(e),f=u?e:this,l=u?{}:e;return c.methods=function(e){return a(s,e,r),c[i]=s,this},c.methods.call(c,l).prototype.constructor=c,c.extend=arguments.callee,c[i].implement=c.statics=function(e,t){return e=typeof e=="string"?function(){var n={};return n[e]=t,n}():e,a(this,e,r),this},c}var e=this,t=e.klass,n="function",r=/xyz/.test(function(){xyz})?/\bsupr\b/:/.*/,i="prototype";return s.noConflict=function(){return e.klass=t,this},s}();e(function(){e(".submittable").on("click.koowa",function(t){t.preventDefault(),(new Koowa.Form(e(t.target).data("config"))).submit()}),e(".-koowa-grid").each(function(){new Koowa.Controller.Grid({form:this})}),e(".-koowa-form").each(function(){new Koowa.Controller.Form({form:this})})}),Koowa.Class=t({options:{},getOptions:function(){return{}},initialize:function(){this.setOptions(this.getOptions())},setOptions:function(t){return typeof t=="object"&&(this.options=e.extend(!0,{},this.options,t)),this}}),Koowa.Translator||(Koowa.Translator=Koowa.Class.extend({translations:{},translate:function(e,t){typeof this.translations[e.toLowerCase()]!="undefined"&&(e=this.translations[e.toLowerCase()]);if(typeof t=="object"&&t!==null)for(var n in t)if(t.hasOwnProperty(n)){var r="{"+n+"}".replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");e=e.replace(new RegExp(r,"g"),t[n])}return e},loadTranslations:function(e){for(var t in e)e.hasOwnProperty(t)&&(this.translations[t.toLowerCase()]=e[t]);return this}}),Koowa.translator=new Koowa.Translator,Koowa.translate=Koowa.translator.translate.bind(Koowa.translator)),Koowa.Form=Koowa.Class.extend({initialize:function(t){this.config=t,this.config.element?this.form=e(document[this.config.element]):(this.form=e("<form/>",{name:"dynamicform",method:this.config.method||"POST",action:this.config.url}),e(document.body).append(this.form))},addField:function(t,n){var r=e("<input/>",{name:t,value:n,type:"hidden"});return r.appendTo(this.form),this},submit:function(){var t=this;this.config.params&&e.each(this.config.params,function(e,n){t.addField(e,n)}),this.form.submit()}}),Koowa.Grid=Koowa.Class.extend({initialize:function(t){var n=this;this.element=e(t),this.form=this.element.is("form")?this.element:this.element.closest("form"),this.toggles=this.element.find(".-koowa-grid-checkall"),this.checkboxes=this.element.find(".-koowa-grid-checkbox").filter(function(t,n){return!e(n).prop("disabled")}),this.checkboxes.length||this.toggles.prop("disabled",!0),this.toggles.on("change.koowa",function(t,r){r||n.checkAll(e(this).prop("checked"))}),this.checkboxes.on("change.koowa",function(e,t){t||n.setCheckAll()})},checkAll:function(t){var n=this.checkboxes.filter(function(n,r){return e(r).prop("checked")!==t});this.checkboxes.prop("checked",t),n.trigger("change",!0)},uncheckAll:function(){this.checkAll(!1)},setCheckAll:function(){var t=this.checkboxes.filter(function(t,n){return e(n).prop("checked")!==!1}).length;this.toggles.prop("checked",this.checkboxes.length===t),this.toggles.trigger("change",!0)}}),Koowa.Grid.getAllSelected=function(t){return e(".-koowa-grid-checkbox:checked",t)},Koowa.Grid.getIdQuery=function(e){return decodeURIComponent(this.getAllSelected(e).serialize())},Koowa.Controller=Koowa.Class.extend({form:null,toolbar:null,buttons:null,token_name:null,token_value:null,getOptions:function(){return e.extend(this.supr(),{toolbar:".koowa-toolbar",url:window.location.href})},initialize:function(t){var n=this;this.supr(),this.setOptions(t),this.form=e(this.options.form),this.setOptions(this.form.data()),this.form.prop("action")&&(this.options.url=this.form.attr("action")),this.toolbar=e(this.options.toolbar),this.form.data("controller",this),this.on("execute",function(){return n.execute.apply(n,arguments)}),this.token_name=this.form.data("token-name"),this.token_value=this.form.data("token-value"),this.toolbar&&this.setToolbar()},setToolbar:function(){var t=this;this.buttons=this.toolbar.find(".toolbar[data-action]"),this.buttons.each(function(){var n=e(this),r={},i=n.data(),s=i.data;if(i.eventAdded)return;typeof s!="object"&&(s=s&&e.type(s)==="string"?e.parseJSON(s):{}),t.token_name&&(s[t.token_name]=t.token_value),r.validate=i.novalidate!=="novalidate",r.data=s,r.action=i.action,n.on("click.koowa",function(e){e.preventDefault(),r.trigger=n;if(!n.hasClass("disabled")){var s=n.data("prompt");if(s&&!confirm(s))return;t.setOptions(i),t.trigger("execute",[r])}}),n.data("event-added",!0)})},execute:function(e,t){if(t.action[0]){var n=t.action[0].toUpperCase()+t.action.substr(1),r="_action"+n;typeof t.validate=="undefined"&&(t.validate=!0),this.trigger("before"+n,t)&&(r=this[r]?r:"_actionDefault",this[r].call(this,t),this.trigger("after"+n,t))}return this},on:function(e,t){return this.form.on("koowa:"+e,t)},off:function(e,t){return this.form.off("koowa:"+e,t)},trigger:function(t,n){var r=e.Event("koowa:"+t);return this.form.trigger(r,n),!r.isDefaultPrevented()},checkValidity:function(){var e;this.buttons&&(this.trigger("beforeValidate"),e=this.buttons.filter('[data-novalidate!="novalidate"]'),this.trigger("validate")?e.removeClass("disabled"):e.addClass("disabled"),this.trigger("afterValidate"))}}),Koowa.Controller.Grid=Koowa.Controller.extend({getOptions:function(){return e.extend(this.supr(),{inputs:".-koowa-grid-checkbox, .-koowa-grid-checkall",ajaxify:!1})},initialize:function(e){var t,n=this;this.supr(e),this.grid=new Koowa.Grid(this.form),this.on("validate",this.validate),this.options.inputs&&this.buttons&&(this.checkValidity(),this.form.find(this.options.inputs).on("change.koowa",function(e,t){t||n.checkValidity()})),this.token_name=this.form.data("token-name"),this.token_value=this.form.data("token-value"),this.setTableHeaders(),this.setTableRows(),this.form.find("thead select, tfoot select").on("change.koowa",function(){n.grid.uncheckAll(),n.options.ajaxify&&(event.preventDefault(),n.options.transport(n.options.url,n.form.serialize(),"get")),n.form.submit()})},setTableHeaders:function(){this.form.find("thead tr > *").each(function(){var t=e(this),n=t.find("a"),r=t.find(".-koowa-grid-checkall");if(n.length)return t.on("click.koowa",function(e){if(e.target!=t[0])return;n.prop("href")?window.location.href=n.prop("href"):n.trigger("click",e)}),n.hasClass("-koowa-asc")?t.addClass("-koowa-asc"):n.hasClass("-koowa-desc")&&t.addClass("-koowa-desc"),this;r.length&&t.on("click.koowa",function(e){if(e.target!=t[0])return!0;r.prop("checked",r.is(":checked")?!1:!0).trigger("change")}),t.addClass("void")})},setTableRows:function(){var t=this,n=this.form.find("tbody tr .-koowa-grid-checkbox");this.form.find("tbody tr").each(function(){var r=e(this),i=r.find(".-koowa-grid-checkbox");if(r.data("readonly")==1||!i.length)return;r.on("click.koowa",function(t){var n=e(t.target);if(n.is("[type=radio], [type=checkbox], a[href]"))return;i.prop("checked",!i.prop("checked")).trigger("change")}),i.on("change.koowa",function(){var t,n=r.parent();e(this).is("[type=radio]")&&n.find(".selected").removeClass("selected"),e(this).prop("checked")?r.addClass("selected"):r.removeClass("selected"),t=r.hasClass("selected")+r.siblings(".selected").length,t>1?n.addClass("selected-multiple").removeClass("selected-single"):n.removeClass("selected-multiple").addClass("selected-single")}).trigger("change",!0),r.find("[data-action]").each(function(){var r=e(this),s={},o=r.data("data"),u=r.data(),a=r.data("event-type");typeof o!="object"&&(o=o&&e.type(o)==="string"?e.parseJSON(o):{}),t.token_name&&(o[t.token_name]=t.token_value),a||(a=r.is('[type="radio"],[type="checkbox"],select')?"change":"click"),s.validate=u.novalidate!=="novalidate",s.data=o,s.action=u.action,r.on(a+".koowa",function(){n.prop("checked",""),i.prop("checked","checked"),n.trigger("change",!0),s.trigger=r,t.setOptions(u),t.trigger("execute",[s])})})})},validate:function(){return Koowa.Grid.getIdQuery()||!1},_actionDelete:function(e){return e.method="delete",this._actionDefault(e)},_actionDefault:function(t){var n=Koowa.Grid.getIdQuery(),r=this.options.url.match(/\?/)?"&":"?",i;if(t.validate&&!this.trigger("validate",[t]))return!1;i={method:"post",url:this.options.url+(n?r+n:""),params:e.extend({},{_action:t.action},t.data)},t.method&&(i.params._method=t.method),(new Koowa.Form(i)).submit()}}),Koowa.Controller.Form=Koowa.Controller.extend({_actionDefault:function(t){if(t.validate&&!this.trigger("validate",[t]))return!1;this.form.append(e("<input/>",{name:"_action",type:"hidden",value:t.action})),this.form.submit()}})}(window.kQuery);